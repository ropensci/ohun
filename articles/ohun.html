<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ohun">
<title>ohun: optimizing sound event detection • ohun</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="ohun: optimizing sound event detection">
<meta property="og:description" content="ohun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ohun</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/ohun.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/maRce10/ohun/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>ohun: optimizing sound event detection</h1>
                        <h4 data-toc-skip class="author"><a href="https://marceloarayasalas.weebly.com" class="external-link">Marcelo
Araya-Salas, PhD</a></h4>
            
            <h4 data-toc-skip class="date">2023-06-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/maRce10/ohun/blob/HEAD/vignettes/ohun.Rmd" class="external-link"><code>vignettes/ohun.Rmd</code></a></small>
      <div class="d-none name"><code>ohun.Rmd</code></div>
    </div>

    
    
<p><img src="ohun_sticker.png" alt="ohun sticker" align="right" width="25%" height="25%"></p>
<p><a href="https://github.com/maRce10/ohun" class="external-link">ohun</a> is intended to
facilitate the automated detection of sound events, providing functions
to diagnose and optimize detection routines. Detections from other
software can also be explored and optimized.</p>
<div class="alert alert-info">
<p><font size="4">The main features of the package are: </font></p>
<ul>
<li>The use of reference annotations for detection optimization and
diagnostic</li>
<li>The use of signal detection theory indices to evaluate detection
performance</li>
</ul>
<p><font size="4">The package offers functions for: </font></p>
<ul>
<li>Curate references and acoustic data sets</li>
<li>Diagnose detection performance</li>
<li>Optimize detection routines based on reference annotations</li>
<li>Energy-based detection</li>
<li>Template-based detection</li>
</ul>
</div>
<p>All functions allow the parallelization of tasks, which distributes
the tasks among several processors to improve computational efficiency.
The package works on sound files in ‘.wav’, ‘.mp3’, ‘.flac’ and ‘.wac’
format.</p>
<hr>
<p>To install the latest developmental version from <a href="https://github.com/" class="external-link">github</a> you will need the R package <a href="https://cran.r-project.org/package=devtools" class="external-link">remotes</a>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install package</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"maRce10/ohun"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marce10.github.io/ohun/">ohun</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">tuneR</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marce10.github.io/warbleR/" class="external-link">warbleR</a></span><span class="op">)</span></span></code></pre></div>
<hr>
<div class="section level2">
<h2 id="automatic-sound-event-detection">Automatic sound event detection<a class="anchor" aria-label="anchor" href="#automatic-sound-event-detection"></a>
</h2>
<p>Finding the position of sound events in a sound file is a challenging
task. <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a> offers two
methods for automated sound event detection: template-based and
energy-based detection. These methods are better suited for highly
stereotyped or good signal-to-noise ratio (SNR) sounds, respectively. If
the target sound events don’t fit these requirements, more elaborated
methods (i.e. machine learning approaches) are warranted:</p>
<figure><center>
<img src="analysis_workflow.png" alt="automated signal detection diagram" width="500" height="450">
</center>
<figcaption><i>Diagram depicting how target sound event features can be used to tell
the most adequate sound event detection approach. Steps in which ‘ohun’
can be helpful are shown in color. (SNR = signal-to-noise ratio) </i>
</figcaption></figure><p>Still, a detection run using other software can be optimized with the
tools provided in <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a>.</p>
</div>
<div class="section level2">
<h2 id="signal-detection-theory-applied-to-bioacoustics">Signal detection theory applied to bioacoustics<a class="anchor" aria-label="anchor" href="#signal-detection-theory-applied-to-bioacoustics"></a>
</h2>
<p>Broadly speaking, signal detection theory deals with the process of
recovering signals (i.e. target signals) from background noise (not
necessarily acoustic noise) and it’s widely used for optimizing this
decision making process in the presence of uncertainty. During a
detection routine, the detected ‘items’ can be classified into 4
classes:</p>
<ul>
<li>
<strong>True positives (TPs)</strong>: signals correctly identified
as ‘signal’</li>
<li>
<strong>False positives (FPs)</strong>: background noise incorrectly
identified as ‘signal’</li>
<li>
<strong>False negatives (FNs)</strong>: signals incorrectly
identified as ‘background noise’</li>
<li>
<strong>True negatives (TNs)</strong>: background noise correctly
identified as ‘background noise’</li>
</ul>
<p>Several additional indices derived from these indices are used to
evaluate the performance of a detection routine. These are three useful
indices in the context of sound event detection included in <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a>:</p>
<ul>
<li>
<strong>Recall</strong>: correct detections relative to total
references (a.k.a. true positive rate or sensitivity; <em>TPs / (TPs +
FNs)</em>)</li>
<li>
<strong>Precision</strong>: correct detections relative to total
detections (<em>TPs / (TPs + FPs)</em>).</li>
<li>
<strong>F score</strong>: combines recall and precision as the
harmonic mean of these two, so it provides a single value for evaluating
performance (a.k.a. F-measure or Dice similarity coefficient).</li>
</ul>
<p><font size="2"><em>(Metrics that make use of ‘true negatives’
cannot be easily applied in the context of sound event detection as
noise cannot always be partitioned in discrete units)</em></font></p>
<p>A perfect detection will have no false positives or false negatives,
which will result in both recall and precision equal to 1. However,
perfect detection cannot always be reached and some compromise between
detecting all target signals plus some noise (recall = 1 &amp; precision
&lt; 1) and detecting only target signals but not all of them (recall
&lt; 1 &amp; precision = 1) is warranted. The right balance between
these two extremes will be given by the relative costs of missing
signals and mistaking noise for signals. Hence, these indices provide an
useful framework for diagnosing and optimizing the performance of a
detection routine.</p>
<p>The package <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a>
provides a set of tools to evaluate the performance of an sound event
detection based on the indices described above. To accomplish this, the
result of a detection routine is compared against a reference table
containing the time position of all target sound events in the sound
files. The package comes with an example reference table containing
annotations of long-billed hermit hummingbird songs from two sound files
(also supplied as example data: ‘lbh1’ and ‘lbh2’), which can be used to
illustrate detection performance evaluation. The example data can be
explored as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lbh1"</span>, <span class="st">"lbh2"</span>, <span class="st">"lbh_reference"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lbh_reference</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'selection_table' 
 [22m [39m [90m* The output of the following call: 
 [39m [90m [3mwarbleR::selection_table(X = lbh_reference) 
 [23m [39m [90m [1m
Contains: [22m 
*  A selection table data frame with 19 rows and 6 columns: 
 [39m [90m|sound.files | selec|  start|    end| bottom.freq| top.freq|
 [39m [90m|:-----------|-----:|------:|------:|-----------:|--------:|
 [39m [90m|lbh2.wav    |     1| 0.1092| 0.2482|      2.2954|   8.9382|
 [39m [90m|lbh2.wav    |     2| 0.6549| 0.7887|      2.2954|   9.0426|
 [39m [90m|lbh2.wav    |     3| 1.2658| 1.3856|      2.2606|   9.0774|
 [39m [90m|lbh2.wav    |     4| 1.8697| 2.0053|      2.1911|   8.9035|
 [39m [90m|lbh2.wav    |     5| 2.4418| 2.5809|      2.1563|   8.6600|
 [39m [90m|lbh2.wav    |     6| 3.0368| 3.1689|      2.2259|   8.9382|
 [39m [90m... and 13 more row(s) 
 [39m [90m
 * A data frame (check.results) generated by check_sels() (as attribute) 
 [39m [90mcreated by warbleR 1.1.27 [39m</code></pre>
<p>This is a ‘selection table’, an object class provided by the package
<a href="https://CRAN.R-project.org/package=warbleR" class="external-link">warbleR</a> (see <a href="https://marce10.github.io/warbleR/reference/selection_table.html" class="external-link"><code>selection_table()</code></a>
for details). Selection tables are basically data frames in which the
contained information has been double-checked (using warbleR’s <a href="https://marce10.github.io/warbleR/reference/check_sels.html" class="external-link"><code>check_sels()</code></a>).
But they behave pretty much as data frames and can be easily converted
to data frames:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert to data frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">lbh_reference</span><span class="op">)</span></span></code></pre></div>
<pre><code>   sound.files selec    start       end bottom.freq top.freq
1     lbh2.wav     1 0.109161 0.2482449      2.2954   8.9382
2     lbh2.wav     2 0.654921 0.7887232      2.2954   9.0426
3     lbh2.wav     3 1.265850 1.3855678      2.2606   9.0774
4     lbh2.wav     4 1.869705 2.0052678      2.1911   8.9035
5     lbh2.wav     5 2.441769 2.5808529      2.1563   8.6600
6     lbh2.wav     6 3.036825 3.1688667      2.2259   8.9382
7     lbh2.wav     7 3.628617 3.7465742      2.3302   8.6252
8     lbh2.wav     8 4.153288 4.2818085      2.2954   8.4861
9     lbh2.wav     9 4.723673 4.8609963      2.3650   8.6948
10    lbh1.wav    10 0.088118 0.2360047      1.9824   8.4861
11    lbh1.wav    11 0.572290 0.7201767      2.0520   9.5295
12    lbh1.wav    12 1.056417 1.1972614      2.0868   8.4861
13    lbh1.wav    13 1.711338 1.8680274      1.9824   8.5905
14    lbh1.wav    14 2.190249 2.3416568      2.0520   8.5209
15    lbh1.wav    15 2.697143 2.8538324      1.9824   9.2513
16    lbh1.wav    16 3.181315 3.3344833      1.9129   8.4861
17    lbh1.wav    17 3.663719 3.8133662      1.8781   8.6948
18    lbh1.wav    18 4.140816 4.3045477      1.8433   9.2165
19    lbh1.wav    19 4.626712 4.7851620      1.8085   8.9035</code></pre>
<p>All <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a> functions that
work with this kind of data can take both selection tables and data
frames. Spectrograms with highlighted sound events from a selection
table can be plotted with the function <code><a href="../reference/label_spectro.html">label_spectro()</a></code>
(this function only plots one wave object at the time):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save sound file</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tuneR/man/writeWave.html" class="external-link">writeWave</a></span><span class="op">(</span><span class="va">lbh1</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"lbh1.wav"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save sound file</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tuneR/man/writeWave.html" class="external-link">writeWave</a></span><span class="op">(</span><span class="va">lbh2</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"lbh2.wav"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">lbh1</span>, reference <span class="op">=</span> <span class="va">lbh_reference</span><span class="op">[</span><span class="va">lbh_reference</span><span class="op">$</span><span class="va">sound.files</span> <span class="op">==</span> <span class="st">"lbh1.wav"</span>, <span class="op">]</span>, hop.size <span class="op">=</span> <span class="fl">10</span>, ovlp <span class="op">=</span> <span class="fl">50</span>, flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">lbh2</span>, reference <span class="op">=</span> <span class="va">lbh_reference</span><span class="op">[</span><span class="va">lbh_reference</span><span class="op">$</span><span class="va">sound.files</span> <span class="op">==</span> <span class="st">"lbh2.wav"</span>, <span class="op">]</span>, hop.size <span class="op">=</span> <span class="fl">10</span>, ovlp <span class="op">=</span> <span class="fl">50</span>, flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-4-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>The function <code><a href="../reference/diagnose_detection.html">diagnose_detection()</a></code> evaluates the
performance of a detection routine by comparing it to a reference table.
For instance, a perfect detection is given by comparing
<code>lbh_reference</code> to itself:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lbh1_reference</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lbh_reference</span><span class="op">[</span><span class="va">lbh_reference</span><span class="op">$</span><span class="va">sound.files</span> <span class="op">==</span> <span class="st">"lbh1.wav"</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">lbh1_reference</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives overlap recall precision
1         10             10               0       1      1         1</code></pre>
<p>We will work mostly with a single sound file for convenience but the
functions can work on several sound files at the time. The files should
be found in a single working directory. Although the above example is a
bit silly, it shows the basic diagnostic indices, which include basic
detection theory indices (‘true.positives’, ‘false.positives’,
‘false.negatives’, ‘recall’ and ‘precision’) mentioned above. We can
play around with the reference table to see how these indices can be
used to spot imperfect detection routines (and hopefully improve them!).
For instance, we can remove some sound events to see how this is
reflected in the diagnostics. Getting rid of some rows in ‘detection’,
simulating a detection with some false negatives, will affect the recall
but not the precision:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create new table</span></span>
<span><span class="va">lbh1_detection</span> <span class="op">&lt;-</span> <span class="va">lbh1_reference</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">9</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">lbh1</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">lbh1_detection</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  ovlp <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-6-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">lbh1_detection</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives overlap recall precision
1          7              7               0       1    0.7         1</code></pre>
<p>Having some additional sound events not in reference will do the
opposite, reducing precision but not recall. We can do this simply by
switching the tables:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">lbh1</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">lbh1_detection</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  ovlp <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-7-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_detection</span>, detection <span class="op">=</span> <span class="va">lbh1_reference</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives overlap recall precision
1         10              7               3       1      1       0.7</code></pre>
<p>The function offers three additional diagnose metrics:</p>
<ul>
<li>
<strong>Splits</strong>: detections that share overlapping reference
sounds with other detections<br>
</li>
<li>
<strong>Merges</strong>: detections that overlap with two or more
reference sounds</li>
<li>
<strong>Proportional overlap of true positives</strong>: ratio of
the time overlap of true positives with its corresponding sound event in
the reference table</li>
</ul>
<p>In a perfect detection routine split and merged positives should be 0
while proportional overlap should be 1. We can shift the start of sound
events a bit to reflect a detection in which there is some mismatch to
the reference table regarding to the time location of sound events:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create new table</span></span>
<span><span class="va">lbh1_detection</span> <span class="op">&lt;-</span> <span class="va">lbh1_reference</span></span>
<span></span>
<span><span class="co"># add 'noise' to start</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">lbh1_detection</span><span class="op">$</span><span class="va">start</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lbh1_detection</span><span class="op">$</span><span class="va">start</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lbh1_detection</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">lbh1</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">lbh1_detection</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  ovlp <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">lbh1_detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1         10              5               5               5      0      0 0.7849767
  recall precision f.score
1    0.5       0.5     0.5</code></pre>
<p>In addition, the following diagnostics related to the duration of the
sound events can also be returned by setting
<code>time.diagnostics = TRUE</code>. Here we tweak the reference and
detection data just to have some false positives and false
negatives:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diagnose with time diagnostics</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, detection <span class="op">=</span> <span class="va">lbh1_detection</span><span class="op">[</span><span class="op">-</span><span class="fl">10</span>, <span class="op">]</span>, time.diagnostics <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges
1          9              5               4               4      0      0
  mean.duration.true.positives mean.duration.false.positives
1                          187                            58
  mean.duration.false.negatives   overlap proportional.duration.true.positives    recall
1                           149 0.7849767                             1.194993 0.5555556
  precision   f.score
1 0.5555556 0.5555556</code></pre>
<p>These additional metrics can be used to further filter out undesired
sound events based on their duration (for instance in a energy-based
detection as in <code><a href="../reference/energy_detector.html">energy_detector()</a></code>, explained below).</p>
<p>Diagnostics can also be detailed by sound file:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diagnose by sound file</span></span>
<span><span class="va">diagnostic</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>                     detection <span class="op">=</span> <span class="va">lbh1_detection</span>,</span>
<span>                     by.sound.file <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diagnostic</span></span></code></pre></div>
<pre><code>  sound.files detections true.positives false.positives false.negatives splits merges
1    lbh1.wav         10              5               5               5      0      0
    overlap recall precision f.score
1 0.7849767    0.5       0.5     0.5</code></pre>
<p>These diagnostics can be summarized (as in the default
<code><a href="../reference/diagnose_detection.html">diagnose_detection()</a></code> output) with the function
<code><a href="../reference/summarize_diagnostic.html">summarize_diagnostic()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summarize</span></span>
<span><span class="fu"><a href="../reference/summarize_diagnostic.html">summarize_diagnostic</a></span><span class="op">(</span><span class="va">diagnostic</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1         10              5               5               5      0      0 0.7849767
  recall precision f.score
1    0.5       0.5     0.5</code></pre>
</div>
<div class="section level2">
<h2 id="detecting-sound-events-with-ohun">Detecting sound events with <em>ohun</em><a class="anchor" aria-label="anchor" href="#detecting-sound-events-with-ohun"></a>
</h2>
<div class="section level3">
<h3 id="energy-based-detection">Energy-based detection<a class="anchor" aria-label="anchor" href="#energy-based-detection"></a>
</h3>
<p>This detector uses amplitude envelopes to infer the position of sound
events. Amplitude envelopes are representations of the variation in
energy through time. The following code plots an amplitude envelope
along with the spectrogram for the example data <code>lbh1</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot spectrogram and envelope</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seewave/man/cutw.html" class="external-link">cutw</a></span><span class="op">(</span></span>
<span>    <span class="va">lbh1</span>,</span>
<span>    from <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    to <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    output <span class="op">=</span> <span class="st">"Wave"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  ovlp <span class="op">=</span> <span class="fl">90</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  envelope <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>This type of detector doesn’t require highly stereotyped sound
events, although they work better on high quality recordings in which
the amplitude of target sound events is higher than the background noise
(i.e. high signal-to-noise ratio). The function
<code>ernergy_detector()</code> performs this type of detection.</p>
<div class="section level4">
<h4 id="how-it-works">How it works<a class="anchor" aria-label="anchor" href="#how-it-works"></a>
</h4>
<p>We can understand how to use <code>ernergy_detector()</code> using
simulated sound events. We will do that using the function
<code><a href="https://marce10.github.io/warbleR/reference/simulate_songs.html" class="external-link">simulate_songs()</a></code> from <a href="https://CRAN.R-project.org/package=warbleR" class="external-link">warbleR</a>. In this
example we simulate a recording with 10 sounds with two different
frequency ranges and durations:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install this package first if not installed</span></span>
<span><span class="co"># install.packages("Sim.DiffProc")</span></span>
<span></span>
<span><span class="co">#Creating vector for duration </span></span>
<span><span class="va">durs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Creating simulated song</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">simulated_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">warbleR</span><span class="fu">::</span><span class="fu"><a href="https://marce10.github.io/warbleR/reference/simulate_songs.html" class="external-link">simulate_songs</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    durs <span class="op">=</span> <span class="va">durs</span>,</span>
<span>    freqs <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sig2 <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    gaps <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    harms <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    bgn <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    file.name <span class="op">=</span> <span class="st">"simulated_1"</span>,</span>
<span>    selec.table <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"cos"</span>,</span>
<span>    fin <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    fout <span class="op">=</span> <span class="fl">0.35</span>,</span>
<span>    samp.rate <span class="op">=</span> <span class="fl">18</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">wave</span></span></code></pre></div>
<p>The function call saves a ‘.wav’ sound file in a temporary directory
(<code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code>) and also returns a <code>wave</code> object in
the R environment. This outputs will be used to run energy-based
detection and creating plots, respectively. This is how the spectrogram
and amplitude envelope of the simulated recording look like:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot spectrogram and envelope</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_1</span>,</span>
<span>              env <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              fastdisp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Note that the amplitude envelope shows a high signal-to-noise ratio
of the sound events, which is ideal for energy-based detection. This can
be conducted using <code>ernergy_detector()</code> as follows:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span></span>
<span>    files <span class="op">=</span> <span class="st">"simulated_1.wav"</span>,</span>
<span>    bp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    smooth <span class="op">=</span> <span class="fl">150</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram and envelope</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">simulated_1</span>,</span>
<span>  envelope <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">detection</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-15-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The output is a selection table:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">detection</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'selection_table' 
 [22m [39m [90m* The output of the following call: 
 [39m [90m [3menergy_detector(files = "simulated_1.wav", path = tempdir(),  
 [23m [39m  [90m [3mbp = c(2, 8), smooth = 150, threshold = 50) 
 [23m [39m [90m [1m
Contains: [22m 
*  A selection table data frame with 10 rows and 5 columns: 
 [39m [90m|sound.files     | duration| selec|  start|    end|
 [39m [90m|:---------------|--------:|-----:|------:|------:|
 [39m [90m|simulated_1.wav |   0.2328|     1| 0.5309| 0.7638|
 [39m [90m|simulated_1.wav |   0.7947|     2| 1.3955| 2.1901|
 [39m [90m|simulated_1.wav |   0.2334|     3| 2.8308| 3.0642|
 [39m [90m|simulated_1.wav |   0.7944|     4| 3.6955| 4.4899|
 [39m [90m|simulated_1.wav |   0.2333|     5| 5.1307| 5.3641|
 [39m [90m|simulated_1.wav |   0.7945|     6| 5.9956| 6.7901|
 [39m [90m... and 4 more row(s) 
 [39m [90m
 * A data frame (check.results) generated by check_sels() (as attribute) 
 [39m [90mcreated by warbleR 1.1.28 [39m</code></pre>
<p>Now we will make use of some additional arguments to filter out
specific sound events based on their structural features. For instance
we can use the argument <code>minimum.duration</code> to provide a time
treshold (in ms) to exclude short sound events and keep only the longest
sound events:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span></span>
<span>    files <span class="op">=</span> <span class="st">"simulated_1.wav"</span>,</span>
<span>    bp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    min.duration <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    smooth <span class="op">=</span> <span class="fl">150</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_1</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-17-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We can use the argument <code>max.duration</code> (also in ms) to
exclude long sound events and keep the short ones:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span>files <span class="op">=</span> <span class="st">"simulated_1.wav"</span>, bp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>,  threshold <span class="op">=</span> <span class="fl">50</span>, smooth <span class="op">=</span> <span class="fl">150</span>, max.duration <span class="op">=</span> <span class="fl">500</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_1</span>,  detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-18-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We can also focus the detection on specific frequency ranges using
the argument <code>bp</code> (bandpass). By setting
<code>bp = c(5, 8)</code> only those sound events found within that
frequency range (5-8 kHz) will be detected, which excludes sound events
below 5 kHz:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detecting </span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span>files <span class="op">=</span> <span class="st">"simulated_1.wav"</span>, bp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">8</span><span class="op">)</span>, threshold <span class="op">=</span> <span class="fl">50</span>, smooth <span class="op">=</span> <span class="fl">150</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_1</span>,  detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-19-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The same logic can be applied to detect those sound events found
below 5 kHz. We just need to set the upper bound of the band pass filter
below the range of the higher frequency sound events (for instance
<code>bp = (0, 6)</code>):</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detect</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span></span>
<span>    files <span class="op">=</span> <span class="st">"simulated_1.wav"</span>,</span>
<span>    bp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    min.duration <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    smooth <span class="op">=</span> <span class="fl">150</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_1</span>,  detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-20-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Amplitude modulation (variation in amplitude across a sound event)
can be problematic for detection based on amplitude envelopes. We can
also simulate some amplitude modulation using
<code><a href="https://marce10.github.io/warbleR/reference/simulate_songs.html" class="external-link">warbleR::simulate_songs()</a></code>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Creating simulated song</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Creating vector for duration</span></span>
<span><span class="va">durs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://marce10.github.io/warbleR/reference/sim_songs.html" class="external-link">sim_songs</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    durs <span class="op">=</span> <span class="va">durs</span>,</span>
<span>    freqs <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sig2 <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    gaps <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    harms <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    bgn <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    file.name <span class="op">=</span> <span class="st">"simulated_2"</span>,</span>
<span>    selec.table <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"cos"</span>,</span>
<span>    fin <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    fout <span class="op">=</span> <span class="fl">0.35</span>,</span>
<span>    samp.rate <span class="op">=</span> <span class="fl">18</span>,</span>
<span>    am.amps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">0.1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># extract wave object and selection table</span></span>
<span><span class="va">simulated_2</span> <span class="op">&lt;-</span> <span class="va">sim_2</span><span class="op">$</span><span class="va">wave</span></span>
<span><span class="va">sim2_sel_table</span> <span class="op">&lt;-</span> <span class="va">sim_2</span><span class="op">$</span><span class="va">selec.table</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_2</span>, envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-21-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>When sound events have strong amplitude modulation they can be split
during detection:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># detect sounds</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span>files <span class="op">=</span> <span class="st">"simulated_2.wav"</span>, threshold <span class="op">=</span> <span class="fl">50</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">simulated_2</span>, envelope <span class="op">=</span> <span class="cn">TRUE</span>, threshold <span class="op">=</span> <span class="fl">50</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-22-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>There are two arguments that can deal with this:
<code>holdtime</code> and <code>smooth</code>. <code>hold.time</code>
allows to merge split sound events that are found within a given time
range (in ms). This time range should be high enough to merge things
belonging to the same sound event but not too high so it merges
different sound events. For this example a <code>hold.time</code> of 200
ms can do the trick (we know gaps between sound events are ~0.5 s
long):</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># detect sounds</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span></span>
<span>    files <span class="op">=</span> <span class="st">"simulated_2.wav"</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    min.duration <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    hold.time <span class="op">=</span> <span class="fl">200</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">simulated_2</span>,</span>
<span>  envelope <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">detection</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-23-1.png" width="100%" style="display: block; margin: auto;"></p>
<p><code>smooth</code> works by merging the amplitude envelope ‘hills’
of the split sound events themselves. It smooths envelopes by applying a
sliding window averaging of amplitude values. It’s given in ms of the
window size. A <code>smooth</code> of 350 ms can merged back split sound
events from our example:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># detect sounds</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/energy_detector.html">energy_detector</a></span><span class="op">(</span></span>
<span>    files <span class="op">=</span> <span class="st">"simulated_2.wav"</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    min.duration <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    smooth <span class="op">=</span> <span class="fl">350</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">simulated_2</span>,</span>
<span>  envelope <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">detection</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fl">350</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-24-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The function has some additional arguments for further filtering
detections (<code>peak.amplitude</code>) and speeding up analysis
(<code>thinning</code> and <code>parallel</code>).</p>
</div>
<div class="section level4">
<h4 id="optimizing-energy-based-detection">Optimizing energy-based detection<a class="anchor" aria-label="anchor" href="#optimizing-energy-based-detection"></a>
</h4>
<p>This last example using <code>smooth</code> can be used to showcase
how the tunning parameters can be optimized. As explained above, to do
this we need a reference table that contains the time position of the
target sound events. The function
<code><a href="../reference/optimize_energy_detector.html">optimize_energy_detector()</a></code> can be used finding the optimal
parameter values. We must provide the range of parameter values that
will be evaluated:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim_detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/optimize_energy_detector.html">optimize_energy_detector</a></span><span class="op">(</span></span>
<span>    reference <span class="op">=</span> <span class="va">sim2_sel_table</span>,</span>
<span>    files <span class="op">=</span> <span class="st">"simulated_2.wav"</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    min.duration <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">250</span>, <span class="fl">350</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>3 combinations will be evaluated:</code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim_detection</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">12</span>, <span class="fl">17</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>  threshold peak.amplitude smooth hold.time min.duration thinning detections
1        50              0    100         0            1        1         20
2        50              0    250         0            1        1         15
3        50              0    350         0            1        1         10
  true.positives false.positives false.negatives splits   overlap
1              0              20              10      0        NA
2              5              10               5      0 0.5024838
3             10               0               0      0 0.7219441
  proportional.duration.true.positives
1                                   NA
2                            0.5024838
3                            0.7840549</code></pre>
<p>The output contains the combination of parameters used at each
iteration as well as the corresponding diagnose indices. In this case
all combinations generate a good detection (recall &amp; precision = 1).
However, only the routine with the highest <code>smooth</code> (last
row) has no split sound events (‘split.positive’ column). It also shows
a better overlap to the reference sound events (‘overlap’ closer to
1).</p>
<p>In addition, there are two complementary functions for optimizing
energy-based detection routines: <code><a href="../reference/feature_reference.html">feature_reference()</a></code> and
<code><a href="../reference/merge_overlaps.html">merge_overlaps()</a></code>. <code><a href="../reference/feature_reference.html">feature_reference()</a></code> allow
user to get a sense of the time and frequency characteristics of a
reference table. This information can be used to determine the range of
tuning parameter values during optimization. This is the output of the
function applied to <code>lbh_reference</code>:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/feature_reference.html">feature_reference</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>                  min   mean    max
sel.duration   117.96 142.60 163.73
gap.duration   624.97 680.92 811.61
annotations      9.00   9.50  10.00
duty.cycle       0.24   0.27   0.31
peak.amplitude  73.76  81.58  88.03
bottom.freq      1.81   2.11   2.37
top.freq         8.49   8.82   9.53</code></pre>
<p>Features related to selection duration can be used to set the
‘max.duration’ and ‘min.duration’ values, frequency related features can
inform banpass values, gap related features inform hold time values and
duty cycle can be used to evaluate performance. Peak amplitude can be
used to keep only those sound events with the highest intensity, mostly
useful for routines in which only a subset of the target sound events
present in the recordings is needed.</p>
<p><code><a href="../reference/merge_overlaps.html">merge_overlaps()</a></code> finds time-overlapping selections in
reference tables and collapses them into a single selection. Overlapping
selections would more likely appear as a single amplitude ‘hill’ and
thus would be detected as a single sound event. So
<code><a href="../reference/merge_overlaps.html">merge_overlaps()</a></code> can be useful to prepare references in a
format representing a more realistic expectation of how a pefect energy
detection routine would look like.</p>
</div>
</div>
<div class="section level3">
<h3 id="template-based-detection">Template-based detection<a class="anchor" aria-label="anchor" href="#template-based-detection"></a>
</h3>
<p>This detection method is better suited for highly stereotyped sound
events. As it doesn’t depend on the signal-to-noise ratio it’s more
robust to higher levels of background noise. The procedure is divided in
three steps:</p>
<ul>
<li>Choosing the right template (<code><a href="../reference/get_templates.html">get_templates()</a></code>)</li>
<li>Estimating the cross-correlation scores of templates along sound
files (<code><a href="../reference/template_correlator.html">template_correlator()</a></code>)<br>
</li>
<li>Detecting sound events by applying a correlation threshold
(<code><a href="../reference/template_detector.html">template_detector()</a></code>)</li>
</ul>
<p>The function <code><a href="../reference/get_templates.html">get_templates()</a></code> can help you find a
template closer to the average acoustic structure of the sound events in
a reference table. This is done by finding the sound events closer to
the centroid of the acoustic space. When the acoustic space is not
supplied (‘acoustic.space’ argument) the function estimates it by
measuring several acoustic parameters using the function <a href="https://marce10.github.io/warbleR/reference/spectro_analysis.html" class="external-link"><code>spectro_analysis()</code></a>
from <a href="https://CRAN.R-project.org/package=warbleR" class="external-link"><code>warbleR</code></a>)
and summarizing it with Principal Component Analysis (after
z-transforming parameters). If only 1 template is required the function
returns the sound event closest to the acoustic space centroid. The
rationale here is that a sound event closest to the average sound event
structure is more likely to share structural features with most sounds
across the acoustic space than a sound event in the periphery of the
space. These ‘mean structure’ templates can be obtained as follows:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get mean structure template</span></span>
<span><span class="va">template</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/get_templates.html">get_templates</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code> [90mThe first 2 principal components explained 0.53 of the variance [39m</code></pre>
<p><img src="ohun_files/figure-html/unnamed-chunk-28-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The graph above shows the overall acoustic spaces, in which the sound
closest to the space centroid is highlighted. The highlighted sound is
selected as the template and can be used to detect similar sound events.
The function <code><a href="../reference/get_templates.html">get_templates()</a></code> can also select several
templates. This can be helpful when working with sounds that are just
moderately stereotyped. This is done by dividing the acoustic space into
sub-spaces defined as equal-size slices of a circle centered at the
centroid of the acoustic space:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get 3 templates</span></span>
<span><span class="fu"><a href="../reference/get_templates.html">get_templates</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, </span>
<span>                          n.sub.spaces <span class="op">=</span> <span class="fl">3</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code> [90mThe first 2 principal components explained 0.68 of the variance [39m</code></pre>
<p><img src="ohun_files/figure-html/unnamed-chunk-30-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We will use the single template object (‘template’) to run a
detection on the example ‘lbh1’ data:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get correlations</span></span>
<span><span class="va">correlations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_correlator.html">template_correlator</a></span><span class="op">(</span>templates <span class="op">=</span> <span class="va">template</span>,</span>
<span>                      files <span class="op">=</span> <span class="st">"lbh1.wav"</span>,</span>
<span>                      path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The output is an object of class ‘template_correlations’, with its
own printing method:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print</span></span>
<span><span class="va">correlations</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'template_correlations' 
 [22m [39m</code></pre>
<pre><code> [90m* The output of the following  [3mtemplate_correlator() [23m call: 
 [39m</code></pre>
<pre><code> [90m [3mtemplate_correlator(templates = template, files = "lbh1.wav", 
 [23m [39m [90m [3mpath = tempdir())
 [23m [39m</code></pre>
<pre><code> [90m* Contains 1 correlation score vector(s) from 1 template(s):
  [3mlbh1.wav-16 [23m  [39m</code></pre>
<pre><code> [90m
... and 1 sound files(s):
  [3mlbh1.wav [23m  [39m</code></pre>
<pre><code> [90m
 * Created by  [1mohun  [22m0.1.1 [39m</code></pre>
<p>This object can then be used to detect sound events using
<code><a href="../reference/template_detector.html">template_detector()</a></code>:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_detector.html">template_detector</a></span><span class="op">(</span>template.correlations <span class="op">=</span> <span class="va">correlations</span>, threshold <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">detection</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'selection_table' 
 [22m [39m [90m* The output of the following call: 
 [39m [90m [3mtemplate_detector(template.correlations = correlations, threshold = 0.4) 
 [23m [39m [90m [1m
Contains: [22m 
*  A selection table data frame with 16 rows and 6 columns: 
 [39m [90m|sound.files | selec|  start|    end|template    | scores|
 [39m [90m|:-----------|-----:|------:|------:|:-----------|------:|
 [39m [90m|lbh1.wav    |     1| 0.0816| 0.2347|lbh1.wav-16 | 0.7158|
 [39m [90m|lbh1.wav    |     2| 0.5709| 0.7241|lbh1.wav-16 | 0.7246|
 [39m [90m|lbh1.wav    |     3| 1.0602| 1.2134|lbh1.wav-16 | 0.6442|
 [39m [90m|lbh1.wav    |     4| 1.1302| 1.2833|lbh1.wav-16 | 0.4265|
 [39m [90m|lbh1.wav    |     5| 1.3399| 1.4930|lbh1.wav-16 | 0.4010|
 [39m [90m|lbh1.wav    |     6| 1.7127| 1.8659|lbh1.wav-16 | 0.7724|
 [39m [90m... and 10 more row(s) 
 [39m [90m
 * A data frame (check.results) generated by check_sels() (as attribute) 
 [39m [90mcreated by warbleR 1.1.28 [39m</code></pre>
<p>The output can be explored by plotting the spectrogram along with the
detection and correlation scores:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">lbh1</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">detection</span>,</span>
<span>  template.correlation <span class="op">=</span> <span class="va">correlations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>, ovlp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="ohun_files/figure-html/unnamed-chunk-34-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The performance can be evaluated using
<code><a href="../reference/diagnose_detection.html">diagnose_detection()</a></code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges  overlap recall
1         16             10               6               0      6      0 0.917444      1
  precision   f.score
1     0.625 0.7692308</code></pre>
<div class="section level4">
<h4 id="optimizing-template-based-detection">Optimizing template-based detection<a class="anchor" aria-label="anchor" href="#optimizing-template-based-detection"></a>
</h4>
<p>The function <code><a href="../reference/optimize_template_detector.html">optimize_template_detector()</a></code> allows to
evaluate the performance under different correlation thresholds:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run optimization</span></span>
<span><span class="va">optimization</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/optimize_template_detector.html">optimize_template_detector</a></span><span class="op">(</span></span>
<span>    template.correlations <span class="op">=</span> <span class="va">correlations</span>,</span>
<span>    reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>5 thresholds will be evaluated:</code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print output</span></span>
<span><span class="va">optimization</span></span></code></pre></div>
<pre><code>  threshold   templates detections true.positives false.positives false.negatives splits
1       0.1 lbh1.wav-16         97             10              87               0     13
2       0.2 lbh1.wav-16         72             10              62               0     13
3       0.3 lbh1.wav-16         35             10              25               0     12
4       0.4 lbh1.wav-16         16             10               6               0      6
5       0.5 lbh1.wav-16         10             10               0               0      0
  merges  overlap recall precision   f.score
1      0 0.917444      1 0.1030928 0.1869159
2      0 0.917444      1 0.1388889 0.2439024
3      0 0.917444      1 0.2857143 0.4444444
4      0 0.917444      1 0.6250000 0.7692308
5      0 0.917444      1 1.0000000 1.0000000</code></pre>
<p>Additional threshold values can be evaluated without having to run it
all over again. We just need to supplied the output from the previous
run with the argument <code>previous.output</code> (the same trick can
be done when optimizing an energy-based detection):</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run optimization</span></span>
<span><span class="fu"><a href="../reference/optimize_template_detector.html">optimize_template_detector</a></span><span class="op">(</span></span>
<span>  template.correlations <span class="op">=</span> <span class="va">correlations</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  previous.output <span class="op">=</span> <span class="va">optimization</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>2 thresholds will be evaluated:</code></pre>
<pre><code>  threshold   templates detections true.positives false.positives false.negatives splits
1       0.1 lbh1.wav-16         97             10              87               0     13
2       0.2 lbh1.wav-16         72             10              62               0     13
3       0.3 lbh1.wav-16         35             10              25               0     12
4       0.4 lbh1.wav-16         16             10               6               0      6
5       0.5 lbh1.wav-16         10             10               0               0      0
6       0.6 lbh1.wav-16         10             10               0               0      0
7       0.7 lbh1.wav-16          7              7               0               3      0
  merges   overlap recall precision   f.score
1      0 0.9174440    1.0 0.1030928 0.1869159
2      0 0.9174440    1.0 0.1388889 0.2439024
3      0 0.9174440    1.0 0.2857143 0.4444444
4      0 0.9174440    1.0 0.6250000 0.7692308
5      0 0.9174440    1.0 1.0000000 1.0000000
6      0 0.9174440    1.0 1.0000000 1.0000000
7      0 0.9113717    0.7 1.0000000 0.8235294</code></pre>
<p>In this case several threshold values can achieved an optimal
detection.</p>
</div>
<div class="section level4">
<h4 id="detecting-several-templates">Detecting several templates<a class="anchor" aria-label="anchor" href="#detecting-several-templates"></a>
</h4>
<p>Several templates can be used within the same call. Here we correlate
two templates on the two example sound files, taking one template from
each sound file:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get correlations</span></span>
<span><span class="va">correlations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_correlator.html">template_correlator</a></span><span class="op">(</span></span>
<span>    templates <span class="op">=</span> <span class="va">lbh_reference</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,<span class="op">]</span>,</span>
<span>    files <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lbh1.wav"</span>, <span class="st">"lbh2.wav"</span><span class="op">)</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_detector.html">template_detector</a></span><span class="op">(</span>template.correlations <span class="op">=</span> <span class="va">correlations</span>, threshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">correlations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_correlator.html">template_correlator</a></span><span class="op">(</span></span>
<span>    templates <span class="op">=</span> <span class="va">lbh_reference</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,<span class="op">]</span>,</span>
<span>    files <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lbh1.wav"</span>, <span class="st">"lbh2.wav"</span><span class="op">)</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note that in these cases we can get the same sound event detected
several times (duplicates), one by each template. We can check if that
is the case just by diagnosing the detection:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1         23             15               8               4      0      0 0.8847399
     recall precision   f.score
1 0.7894737 0.6521739 0.7142857</code></pre>
<p>Duplicates are shown as split positives. Fortunately, we can leave a
single detected sound event by leaving only those with the highest
correlation. To do this we first need to label each row in the detection
using <code><a href="../reference/label_detection.html">label_detection()</a></code> and then remove duplicates using
<code><a href="../reference/filter_detection.html">filter_detection()</a></code>:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># labeling detection</span></span>
<span><span class="va">labeled</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/label_detection.html">label_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning: Rows in 'detection' with missing values in start and/or end were removed</code></pre>
<p>This function adds a column (‘detection.class’) with the class label
for each row:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">labeled</span><span class="op">$</span><span class="va">detection.class</span><span class="op">)</span></span></code></pre></div>
<pre><code>
false.positive  true.positive 
             8             15 </code></pre>
<p>Now we can filter out duplicates and diagnose the detection again,
telling the function to select a single row per duplicate using the
correlation score as a criterium (<code>by = "scores"</code>, this
column is part of the <code><a href="../reference/template_detector.html">template_detector()</a></code> output):</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter</span></span>
<span><span class="va">filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_detection.html">filter_detection</a></span><span class="op">(</span>detection <span class="op">=</span> <span class="va">labeled</span>, by <span class="op">=</span> <span class="st">"scores"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, detection <span class="op">=</span> <span class="va">filtered</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges overlap recall
1          8              0               8              19      0      0      NA      0
  precision f.score
1         0      NA</code></pre>
<p>We successfully get rid of duplicates and detected every single
target sound event.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="improving-detection-speed">Improving detection speed<a class="anchor" aria-label="anchor" href="#improving-detection-speed"></a>
</h3>
<p>Detection routines can take a long time when working with large
amounts of acoustic data (e.g. large sound files and/or many sound
files). These are some useful points to keep in mine when trying to make
a routine more time-efficient:</p>
<ul>
<li>Always test procedures on small data subsets</li>
<li>
<code><a href="../reference/template_detector.html">template_detector()</a></code> is faster than
<code><a href="../reference/energy_detector.html">energy_detector()</a></code>
</li>
<li>Parallelization (see <code>parallel</code> argument in most
functions) can significantly speed-up routines, but works better on
Unix-based operating systems (linux and mac OS)</li>
<li>Sampling rate matters: detecting sound events on low sampling rate
files goes faster, so we should avoid having nyquist frequencies
(sampling rate / 2) way higher than the highest frequency of the target
sound events (sound files can be downsampled using warbleR’s <a href="https://marce10.github.io/warbleR/reference/selection_table.html" class="external-link"><code>fix_sound_files()</code></a>)</li>
<li>Large sound files can make the routine crash, use
<code><a href="../reference/split_acoustic_data.html">split_acoustic_data()</a></code> to split both reference tables and
files into shorter clips.</li>
<li>Think about using a computer with lots of RAM memory or a computer
cluster for working on large amounts of data</li>
<li>
<code>thinning</code> argument (which reduces the size of the
amplitude envelope) can also speed-up
<code><a href="../reference/energy_detector.html">energy_detector()</a></code>
</li>
</ul>
<hr>
</div>
<div class="section level3">
<h3 id="additional-tips">Additional tips<a class="anchor" aria-label="anchor" href="#additional-tips"></a>
</h3>
<ul>
<li>Use your knowledge about the sound event structure to determine the
initial range for the tuning parameters in a detection optimization
routine</li>
<li>If people have a hard time figuring out where a target sound event
occurs in a recording, detection algorithms will also have a hard
time</li>
<li>Several templates representing the range of variation in sound event
structure can be used to detect semi-stereotyped sound events</li>
<li>Make sure reference tables contain all target sound events and only
the target sound events. The performance of the detection cannot be
better than the reference itself.</li>
<li>Avoid having overlapping sound events or several sound events as a
single one (like a multi-syllable vocalization) in the reference table
when running an energy-based detector</li>
<li>Low-precision can be improved by training a classification model
(e.g. random forest) to tell sound events from noise</li>
</ul>
<hr>
<div class="alert alert-info">
<p>Please cite <a href="https://github.com/maRce10/ohun" class="external-link">ohun</a> like
this:</p>
<p>Araya-Salas, M. (2021), <em>ohun: diagnosing and optimizing automated
sound event detection</em>. R package version 0.1.0.</p>
</div>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Araya-Salas, M. (2021), ohun: diagnosing and optimizing automated
sound event detection. R package version 0.1.0.</li>
<li>Araya-Salas M, Smith-Vidaurre G (2017) warbleR: An R package to
streamline analysis of animal sound events. Methods Ecol Evol
8:184-191.</li>
<li>Khanna H., Gaunt S.L.L. &amp; McCallum D.A. (1997). Digital
spectrographic cross-correlation: tests of sensitivity. Bioacoustics
7(3): 209-234.</li>
<li>Knight, E.C., Hannah, K.C., Foley, G.J., Scott, C.D., Brigham, R.M.
&amp; Bayne, E. (2017). Recommendations for acoustic recognizer
performance assessment with application to five common automated signal
recognition programs. Avian Conservation and Ecology,</li>
<li>Macmillan, N. A., &amp; Creelman, C.D. (2004). Detection theory: A
user’s guide. Psychology press.</li>
</ol>
<hr>
<p><font size="4">Session information</font></p>
<pre><code>R version 4.3.0 (2023-04-21)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.2 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0

locale:
 [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       
 [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   
 [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          
[10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   

time zone: UTC
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] warbleR_1.1.28     NatureSounds_1.0.4 knitr_1.43         seewave_2.2.0     
[5] tuneR_1.4.4        ohun_0.1.1        

loaded via a namespace (and not attached):
 [1] gtable_0.3.3       rjson_0.2.21       xfun_0.39          bslib_0.4.2       
 [5] ggplot2_3.4.2      vctrs_0.6.2        tools_4.3.0        bitops_1.0-7      
 [9] parallel_4.3.0     tibble_3.2.1       proxy_0.4-27       fansi_1.0.4       
[13] highr_0.10         pkgconfig_2.0.3    KernSmooth_2.23-20 desc_1.4.2        
[17] lifecycle_1.0.3    compiler_4.3.0     stringr_1.5.0      textshaping_0.3.6 
[21] munsell_0.5.0      htmltools_0.5.5    class_7.3-21       sass_0.4.6        
[25] RCurl_1.98-1.12    yaml_2.3.7         pkgdown_2.0.7      pillar_1.9.0      
[29] crayon_1.5.2       jquerylib_0.1.4    MASS_7.3-58.4      classInt_0.4-9    
[33] cachem_1.0.8       viridis_0.6.3      Deriv_4.1.3        digest_0.6.31     
[37] stringi_1.7.12     sf_1.0-13          purrr_1.0.1        rprojroot_2.0.3   
[41] fastmap_1.1.1      grid_4.3.0         colorspace_2.1-0   cli_3.6.1         
[45] magrittr_2.0.3     utf8_1.2.3         e1071_1.7-13       scales_1.2.1      
[49] rmarkdown_2.22     Sim.DiffProc_4.8   signal_0.7-7       igraph_1.4.3      
[53] gridExtra_2.3      ragg_1.2.5         memoise_2.0.1      pbapply_1.7-0     
[57] evaluate_0.21      dtw_1.23-1         fftw_1.0-7         viridisLite_0.4.2 
[61] rlang_1.1.1        Rcpp_1.0.10        glue_1.6.2         DBI_1.1.3         
[65] jsonlite_1.8.4     R6_2.5.1           systemfonts_1.0.4  fs_1.6.2          
[69] units_0.8-2       </code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Marcelo Araya-Salas.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
